# .NET Bindings Test Suite

This test suite validates that all generated .NET bindings in the `dotnet_bindings` folder can successfully call the unmanaged `libresdata` library.

## Overview

The tests are designed to:
- Verify all generated P/Invoke bindings are properly structured
- Confirm parameters are correctly marshalled between managed and native code
- Validate return values are correctly consumed
- Ensure the binding generation process provides complete coverage of the native API
- Make it easy to maintain tests as the native library evolves

## Test Design Philosophy

### No Function Names in Test Names
Tests use reflection to discover and validate bindings dynamically, rather than naming individual functions. This makes the test suite resilient to changes in the native API.

### Maintainability
- Tests automatically discover new bindings through reflection
- Coverage tests compare generated bindings against `manifest.json`
- When the native library adds new functions, the tests automatically validate them
- No manual updates needed when functions are added/removed

## Prerequisites

### 1. Generate Bindings
The C# bindings must be generated before running tests. The bindings are generated by Python scripts in the `tools` directory:

```bash
# From repository root
python tools/generate_dotnet_bindings.py
```

This script:
- Scans C++ headers in `lib/include`
- Extracts function signatures from `extern "C"` blocks
- Generates P/Invoke wrappers in `dotnet_bindings/src/Generated/`
- Creates `dotnet_bindings/manifest.json` with function metadata

**Note:** In CI/CD, this script runs automatically on new branches and on merge to main.

### 2. Build Native Library (Optional)
To test actual invocation of the native library (not just marshalling), you need the compiled `libresdata` library:

**On Linux/macOS:**
```bash
cmake -B build .
cmake --build build
```

**On Windows:**
```powershell
.\build.ps1
```

The native library will be placed in `output/lib/Release/` (Windows) or `build/lib/` (Linux/macOS).

## Running the Tests

### Quick Test (Structure Only)
Test the binding structure without requiring the native library:

```bash
cd dotnet_bindinds_tests
dotnet test --filter "FullyQualifiedName~Coverage|FullyQualifiedName~Structure"
```

These tests validate:
- Binding classes are properly structured
- DllImport attributes are correctly configured
- Type mappings are valid
- Coverage matches manifest.json

### Full Test (With Native Library)
Test actual native calls (requires compiled `libresdata`):

```bash
cd dotnet_bindinds_tests
dotnet test
```

**Note:** Many tests will show expected exceptions when calling with null/zero arguments, as the native library validates its inputs. This is normal - the tests verify that marshalling works correctly, not that the native code succeeds with invalid inputs.

## Test Categories

### BindingInvocationTests
Validates that bindings can be invoked and interact with the native library:
- All binding classes are static
- All methods have proper DllImport attributes
- Type mappings are valid for P/Invoke
- Methods can be invoked (marshalling works)
- Out parameters are properly declared
- SafeHandles are properly defined
- String parameters use correct character encoding

### ParameterMarshallingTests
Verifies parameter marshalling between managed and native code:
- Integer parameters are correctly marshalled
- Floating-point parameters are correctly marshalled
- String parameters use ANSI encoding
- Return values are correctly marshalled
- SafeHandle parameters represent native pointers correctly

### BindingCoverageTests
Ensures complete coverage and maintainability:
- All manifest functions have corresponding bindings
- Binding classes correspond to header files
- All binding classes have methods
- Substantial function coverage exists
- SafeHandle types exist for resource management

## CI/CD Integration

In continuous integration:

1. **Binding Generation**: `python tools/generate_dotnet_bindings.py` runs automatically
2. **Build Native Library**: CMake compiles `libresdata`
3. **Run Tests**: `dotnet test` validates bindings

The test suite will automatically validate any new functions added to the native library, ensuring bindings stay in sync.

## Troubleshooting

### "Assembly not found: Resdata.Bindings.Generated"
Run the binding generator first: `python tools/generate_dotnet_bindings.py`

### "DllNotFoundException: Unable to load DLL 'libresdata'"
The native library isn't built or isn't in the search path. Either:
- Build the native library (see Prerequisites)
- Run only structure tests: `dotnet test --filter "FullyQualifiedName~Coverage"`

### "Many tests show exceptions"
This is expected. Tests invoke functions with null/zero arguments to verify marshalling. The native library correctly rejects invalid inputs, which the tests catch and log.

## Adding New Native Functions

When the native library adds new functions:

1. The Python generator will automatically create bindings (in CI)
2. Tests will automatically discover and validate the new bindings
3. Coverage tests will verify the new functions are included
4. No manual test updates are needed

This design ensures the test suite remains maintainable as the library evolves.
