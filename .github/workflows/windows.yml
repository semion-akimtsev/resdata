name: Windows Compile

env:
  CONFIG: "Release"

on:
 push:
   branches:
     - main
     - 'version-**'
   tags: "*"
 pull_request:
   branches:
     - main
     - 'version-**'
 workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  build-cmake:
    name: CMake

    strategy:
      fail-fast: false
      matrix:
        os: ['windows-2022']

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v5
      with:
        # required for `git describe --tags` to work
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python.exe -m pip install --upgrade pip
        python.exe -m pip install --upgrade conan

    - name: Determine version via GitVersion
      uses: gittools/actions/gitversion@v5
      id: gitversion
      with:
        useConfigFile: true

    - name: Export RD_VERSION for native build
      shell: pwsh
      run: |
        Add-Content -Path $env:GITHUB_ENV -Value "RD_VERSION=${{ steps.gitversion.outputs.MajorMinorPatch }}"

    - name: Build
      run: |
        ./build.ps1

    - name: Setup .NET 9 SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'

    - name: Generate C# bindings
      run: |
        python tools/generate_dotnet_bindings.py

    - name: Restore & Build generated bindings
      run: |
        dotnet restore dotnet_bindings/src/ResdataBindings.csproj
        dotnet build dotnet_bindings/src/ResdataBindings.csproj -c Release

    - name: Copy native libresdata into package runtime folder
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path dotnet_bindings/src/runtimes/win-x64/native -Force | Out-Null
        $src1 = Join-Path 'output\lib' $env:CONFIG
        $src2 = Join-Path 'output\lib' ($env:CONFIG.ToLower())
        if (Test-Path $src1) {
          $src = $src1
        } elseif (Test-Path $src2) {
          $src = $src2
        } else {
          Write-Error "No native build output found at $src1 or $src2"
          exit 1
        }
        Copy-Item -Path (Join-Path $src '*') -Destination dotnet_bindings/src/runtimes/win-x64/native -Force

    - name: Write version info into dotnet project (for packaging)
      shell: pwsh
      env:
        NV2: ${{ steps.gitversion.outputs.NuGetVersionV2 }}
        FULL: ${{ steps.gitversion.outputs.FullSemVer }}
        COMMIT: ${{ steps.gitversion.outputs.CommitId }}
        BRANCH: ${{ steps.gitversion.outputs.BranchName }}
      run: |
        $out = 'dotnet_bindings/src/VersionInfo.json'
        $obj = @{
          version = $env:NV2
          fullSemVer = $env:FULL
          commit = $env:COMMIT
          branch = $env:BRANCH
          generatedUtc = (Get-Date).ToString('o')
        }
        $json = $obj | ConvertTo-Json -Depth 5
        $dir = Split-Path $out -Parent
        if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }
        $json | Out-File -FilePath $out -Encoding utf8
        Write-Host "Wrote version info to $out"

    - name: Pack generated bindings (NuGet)
      run: |
        dotnet pack dotnet_bindings/src/ResdataBindings.csproj -c Release -o dotnet_bindings/artifacts /p:PackageVersion=${{ steps.gitversion.outputs.NuGetVersionV2 }} /p:RepositoryCommit=${{ steps.gitversion.outputs.CommitId }} /p:RepositoryUrl=https://github.com/${{ github.repository }}

    - name: Ensure GitHub Packages PAT is set (tags only)
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      shell: pwsh
      env:
        NUGET_PAT: ${{ secrets.NUGET_PAT }}
      run: |
        if (-not $env:NUGET_PAT) {
          Write-Error "Secret NUGET_PAT is required to publish the NuGet package to this repository's feed on tags; aborting"
          exit 1
        }

    - name: Publish NuGet package to GitHub Packages (tags only)
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      shell: pwsh
      env:
        NUGET_PAT: ${{ secrets.NUGET_PAT }}
        GITHUB_OWNER: ${{ github.repository_owner }}
      run: |
        Write-Host "Publishing NuGet package(s) to GitHub Packages for owner: $env:GITHUB_OWNER"
        # ensure a source exists (ignore if already present)
        dotnet nuget add source "https://nuget.pkg.github.com/$env:GITHUB_OWNER/index.json" --name "github" --username $env:GITHUB_OWNER --password $env:NUGET_PAT --store-password-in-clear-text -NonInteractive -Force || Write-Host "nuget source add may have failed (already present)"
        $pkgs = Get-ChildItem -Path dotnet_bindings/artifacts -Filter '*.nupkg'
        if ($pkgs.Count -eq 0) { Write-Error "No nupkg found to publish"; exit 1 }
        foreach ($p in $pkgs) {
          Write-Host "Pushing $($p.FullName)"
          dotnet nuget push $p.FullName --source "https://nuget.pkg.github.com/$env:GITHUB_OWNER/index.json" --api-key $env:NUGET_PAT --skip-duplicate -v minimal
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Binaries
        path: output\lib\${{env.CONFIG}}\*
        if-no-files-found: error
        retention-days: 30
